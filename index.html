<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý bệnh nhân nội trú Ung bướu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      @media print {
        /* Define page layout for printing */
        @page {
            size: A4;
            margin: 1.5cm;
        }

        body {
            background-color: #fff !important; /* Ensure white background */
            margin: 0;
            padding: 0;
        }

        /* Hide all elements specifically marked as non-printable.
           This includes the main app header, footer, buttons, etc. */
        .no-print {
            display: none !important;
        }

        /* The following rules reset the modal's styling so its content
           can flow like a normal document instead of being a fixed-size overlay. */

        /* 1. Reset the modal's full-screen overlay */
        .fixed.inset-0 {
            position: static !important;
            background: none !important;
            padding: 0 !important;
        }

        /* 2. Reset the modal's main dialog box (the white container) */
        .fixed.inset-0 > div {
            width: auto !important;
            max-width: none !important;
            height: auto !important;
            max-height: none !important;
            box-shadow: none !important;
            border: none !important;
            display: block !important; /* Crucial: This disables flexbox constraints */
            margin: 0 !important;
            padding: 0 !important;
        }

        /* 3. Reset the modal's content area to allow it to expand */
        .modal-content-area {
            overflow: visible !important;
            height: auto !important;
            max-height: none !important;
            padding: 0 !important;
        }

        /* 4. Let the print area flow naturally within the document */
        #print-area {
            padding: 0; /* Page margins are handled by @page */
            margin: 0;
            font-size: 11pt; /* Use points for better print scaling */
        }
        
        /* Ensure patient blocks do not get split across pages */
        #print-area .break-inside-avoid {
            page-break-inside: avoid;
        }

        /* Specific font sizes for report elements */
        #print-area h3 {
          font-size: 16pt;
        }
        #print-area h4 {
          font-size: 13pt;
        }
        #print-area p, #print-area span, #print-area div {
            /* !important is needed to override inline tailwind styles */
            font-size: 11pt !important;
        }
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js",
    "firebase/auth": "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js",
    "firebase/firestore": "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"
  }
}
</script>
<!-- Load Babel -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
  <body class="bg-gray-100">
    <div id="root"></div>
    <!-- Babel transforms JSX and handles ES modules -->
    <script type="text/babel" data-type="module">
      import React, { useState, useMemo, useEffect } from 'react';
      import ReactDOM from 'react-dom/client';
      import { initializeApp } from 'firebase/app';
      import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'firebase/auth';
      import { getFirestore, collection, getDocs, doc, addDoc, updateDoc, deleteDoc } from 'firebase/firestore';

      // --- CẤU HÌNH FIREBASE ---
      const firebaseConfig = {
        apiKey: "AIzaSyCSbyl8FkGDjoUCUuO2EtShH--uAHOL3hY",
        authDomain: "noitruub.firebaseapp.com",
        projectId: "noitruub",
        storageBucket: "noitruub.firebasestorage.app",
        messagingSenderId: "938135666001",
        appId: "1:938135666001:web:2476aba951c1a2b24fa770",
        measurementId: "G-WBZ3PTNKXZ"
      };
      
      // Khởi tạo Firebase
      const firebaseApp = initializeApp(firebaseConfig);
      const firebaseAuth = getAuth(firebaseApp);
      const db = getFirestore(firebaseApp);

      // --- Start of inlined code from types.js ---
      const AdmissionStatus = {
        INPATIENT: 'Nội trú',
        DISCHARGED: 'Ra viện',
        DISCHARGE_TODAY: 'Dự kiến ra viện',
      };
      
      // --- Start of inlined code from components/Modal.js ---
      const Modal = ({ isOpen, onClose, title, children }) => {
        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
              <div className="flex justify-between items-center p-4 border-b no-print">
                <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                <button
                  onClick={onClose}
                  className="text-gray-500 hover:text-gray-800 transition-colors"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              <div className="p-6 overflow-y-auto modal-content-area">
                {children}
              </div>
            </div>
          </div>
        );
      };

      // --- Start of inlined code from components/PatientForm.js ---
      const PatientForm = ({ onSave, onClose, patientToEdit }) => {
        const [formData, setFormData] = useState({
          name: '',
          birthYear: '',
          patientCode: '',
          roomNumber: '',
          reason: '',
          diagnosis: '',
          status: AdmissionStatus.INPATIENT,
          newNote: '', // Changed from 'notes'
        });

        useEffect(() => {
          if (patientToEdit) {
            setFormData({
              name: patientToEdit.name,
              birthYear: patientToEdit.birthYear.toString(),
              patientCode: patientToEdit.patientCode,
              roomNumber: patientToEdit.roomNumber,
              reason: patientToEdit.reason,
              diagnosis: patientToEdit.diagnosis, // Keep latest diagnosis
              status: patientToEdit.status,
              newNote: '', // Always start with an empty note field
            });
          } else {
            // Logic for new patient
            setFormData({
              name: '',
              birthYear: '',
              patientCode: '',
              roomNumber: '',
              reason: '',
              diagnosis: '',
              status: AdmissionStatus.INPATIENT,
              newNote: '',
            });
          }
        }, [patientToEdit]);

        const handleChange = (e) => {
          const { name, value } = e.target;
          setFormData(prev => ({ ...prev, [name]: value }));
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          const patientData = {
            ...formData,
            birthYear: parseInt(formData.birthYear, 10),
          };
          if (patientToEdit) {
            onSave({ ...patientData, id: patientToEdit.id });
          } else {
            onSave({ ...patientData, notes: patientData.newNote });
          }
        };
        
        const sortedHistory = patientToEdit?.history?.slice().reverse() ?? [];

        return (
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700">Họ tên bệnh nhân</label>
                <input type="text" name="name" value={formData.name} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" required />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">Năm sinh</label>
                <input type="number" name="birthYear" value={formData.birthYear} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" required />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">Mã số bệnh nhân</label>
                <input type="text" name="patientCode" value={formData.patientCode} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" required />
              </div>
               <div>
                <label className="block text-sm font-medium text-gray-700">Số phòng</label>
                <input type="text" name="roomNumber" value={formData.roomNumber} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" required />
              </div>
               <div>
                <label className="block text-sm font-medium text-gray-700">Tình trạng nhập viện</label>
                <select name="status" value={formData.status} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                  {Object.values(AdmissionStatus).map(status => (
                    <option key={status} value={status}>{status}</option>
                  ))}
                </select>
              </div>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">Lý do vào viện</label>
              <textarea name="reason" value={formData.reason} onChange={handleChange} rows={3} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">Chẩn đoán hiện tại</label>
              <textarea name="diagnosis" value={formData.diagnosis} onChange={handleChange} rows={3} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
             <div>
              <label className="block text-sm font-medium text-gray-700">Ghi chú / Diễn biến mới</label>
              <textarea name="newNote" value={formData.newNote} onChange={handleChange} placeholder="Thêm diễn biến, y lệnh, hoặc thông tin bàn giao mới..." rows={3} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>

            {patientToEdit && sortedHistory.length > 0 && (
                <div className="pt-4 mt-4 border-t">
                    <h3 className="text-lg font-medium text-gray-800 mb-2">Lịch sử điều trị & Ghi chú</h3>
                    <div className="space-y-3 max-h-60 overflow-y-auto pr-2">
                        {sortedHistory.map((entry, index) => (
                            <div key={index} className="bg-gray-50 p-3 rounded-md border border-gray-200">
                                <p className="text-xs font-semibold text-gray-500 mb-1">
                                    {new Date(entry.date).toLocaleString('vi-VN')}
                                </p>
                                <p className="text-sm"><span className="font-semibold">Chẩn đoán:</span> {entry.diagnosis}</p>
                                <p className="text-sm"><span className="font-semibold">Ghi chú:</span> {entry.notes}</p>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            <div className="flex justify-end space-x-3 pt-4">
              <button type="button" onClick={onClose} className="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors">Hủy</button>
              <button type="submit" className="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors">{patientToEdit ? 'Cập nhật' : 'Thêm mới'}</button>
            </div>
          </form>
        );
      };

      // --- Start of inlined code from components/ReportView.js ---
      const ReportView = ({ patients, onClose }) => {
        const patientsToReport = patients
          .filter(
            p => p.status === AdmissionStatus.INPATIENT || p.status === AdmissionStatus.DISCHARGE_TODAY
          )
          .sort((a, b) => (a.roomNumber || '').localeCompare(b.roomNumber || '', undefined, { numeric: true }));

        const handlePrint = () => {
          window.print();
        };
        
        const today = new Date().toLocaleDateString('vi-VN');

        return (
          <div className="space-y-6">
            <div id="print-area">
              <h3 className="text-2xl font-bold text-center text-gray-800 mb-2">Báo cáo bệnh nhân nội trú Ung bướu</h3>
              <p className="text-center text-gray-600 mb-6">Ngày: {today}</p>
              
              <div className="space-y-4">
                  {patientsToReport.length > 0 ? (
                      patientsToReport.map((patient, index) => (
                          <div key={patient.id} className="p-4 border border-gray-200 rounded-lg bg-gray-50 break-inside-avoid">
                              <div className="flex justify-between items-start">
                                 <h4 className="text-lg font-semibold text-indigo-700">{index + 1}. {patient.name} - {patient.birthYear}</h4>
                                 <span className={`text-sm font-medium px-2 py-1 rounded-full ${
                                  patient.status === AdmissionStatus.INPATIENT ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'
                                 }`}>
                                   {patient.status}
                                 </span>
                              </div>
                              <p className="text-sm text-gray-500 mb-2">MSBN: {patient.patientCode} | Phòng: {patient.roomNumber}</p>
                              <div className="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                  <p className="break-words"><span className="font-semibold text-gray-600">Lý do vào viện:</span> {patient.reason}</p>
                                  <p className="break-words"><span className="font-semibold text-gray-600">Chẩn đoán:</span> {patient.diagnosis}</p>
                                  <p className="col-span-2 break-words"><span className="font-semibold text-gray-600">Ghi chú gần nhất:</span> {patient.notes}</p>
                              </div>
                          </div>
                      ))
                  ) : (
                      <p className="text-center text-gray-500 py-8">Không có bệnh nhân nào cần báo cáo.</p>
                  )}
              </div>
              <div className="mt-8 text-right text-sm text-gray-600">
                  <p>bshieuubdl@gmail.com</p>
              </div>
            </div>
            <div className="flex justify-end space-x-3 pt-4 no-print">
              <button type="button" onClick={onClose} className="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors">Đóng</button>
              <button type="button" onClick={handlePrint} className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors flex items-center space-x-2">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fillRule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7V9h6v3z" clipRule="evenodd" />
                  </svg>
                  <span>In Báo Cáo</span>
              </button>
            </div>
          </div>
        );
      };

      // --- New component: ConfirmModal ---
      const ConfirmModal = ({ isOpen, onClose, onConfirm, title, children }) => {
        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 bg-black bg-opacity-60 z-50 flex justify-center items-center p-4" role="dialog" aria-modal="true" aria-labelledby="modal-title">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-md">
              <div className="p-6">
                <div className="sm:flex sm:items-start">
                  <div className="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                    <svg className="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                  </div>
                  <div className="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left">
                    <h3 className="text-lg leading-6 font-medium text-gray-900" id="modal-title">
                      {title}
                    </h3>
                    <div className="mt-2">
                      <div className="text-sm text-gray-500">
                        {children}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div className="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse rounded-b-lg">
                <button
                  type="button"
                  onClick={onConfirm}
                  className="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm"
                >
                  Xác nhận Xóa
                </button>
                <button
                  type="button"
                  onClick={onClose}
                  className="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:w-auto sm:text-sm"
                >
                  Hủy
                </button>
              </div>
            </div>
          </div>
        );
      };

      // --- New component: SyncStatusIndicator ---
      const SyncStatusIndicator = ({ status, error }) => {
          if (status === 'idle') return null;

          const getStatusContent = () => {
              switch (status) {
                  case 'loading': return { text: 'Đang tải...', icon: 'animate-spin h-4 w-4 mr-2', color: 'text-gray-600' };
                  case 'syncing': return { text: 'Đang đồng bộ...', icon: 'animate-spin h-4 w-4 mr-2', color: 'text-gray-600' };
                  case 'success': return { text: 'Đã đồng bộ', icon: 'h-4 w-4 mr-2', color: 'text-green-600' };
                  case 'error': return { text: `Lỗi: ${error}`, icon: 'h-4 w-4 mr-2', color: 'text-red-600' };
                  default: return null;
              }
          };

          const content = getStatusContent();
          if (!content) return null;

          const iconMap = {
            spinner: <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>,
            success: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" /></svg>,
            error: <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" /></svg>,
          };
          
          let icon;
          if (status === 'loading' || status === 'syncing') icon = iconMap.spinner;
          else if (status === 'success') icon = iconMap.success;
          else if (status === 'error') icon = iconMap.error;

          return (
              <div className={`flex items-center text-xs mt-1 ${content.color}`}>
                  <div className={content.icon}>{icon}</div>
                  <span>{content.text}</span>
              </div>
          );
      };
      
      // --- Start of inlined code from App.js ---
      const StatusBadge = ({ status }) => {
          const statusClasses = useMemo(() => {
              switch (status) {
                  case AdmissionStatus.INPATIENT: return 'bg-blue-100 text-blue-800';
                  case AdmissionStatus.DISCHARGE_TODAY: return 'bg-yellow-100 text-yellow-800';
                  case AdmissionStatus.DISCHARGED: return 'bg-green-100 text-green-800';
                  default: return 'bg-gray-100 text-gray-800';
              }
          }, [status]);

          return <span className={`px-3 py-1 text-xs font-medium rounded-full ${statusClasses}`}>{status}</span>;
      };

      const PatientTable = ({ patients, onEdit, onDelete }) => {
        return (
          <div className="md:border-t">
              {patients.map((patient, index) => (
                  <div key={patient.id} className="bg-white p-4 mb-4 rounded-lg shadow md:shadow-none md:rounded-none md:mb-0 md:grid md:grid-cols-[50px_1fr_120px_100px_1fr_120px_120px] md:gap-x-6 md:px-6 md:py-4 md:border-b hover:bg-gray-50 items-center">
                      
                      {/* STT (Desktop) */}
                      <div className="hidden md:block text-center text-gray-500">{index + 1}</div>
                      
                      {/* --- MOBILE CARD VIEW --- */}
                      <div className="md:hidden">
                        <div className="flex justify-between items-start">
                          <h3 className="font-bold text-lg text-gray-800 mb-2 pr-2">
                            {index + 1}. {patient.name} <span className="font-normal text-gray-500">({patient.birthYear})</span>
                          </h3>
                          <div className="flex justify-end items-center space-x-3 flex-shrink-0 pl-2">
                            <button onClick={() => onEdit(patient)} className="font-medium text-indigo-600 hover:text-indigo-800">Sửa</button>
                            <button onClick={() => onDelete(patient)} className="font-medium text-red-600 hover:text-red-800">Xóa</button>
                          </div>
                        </div>
                        <div className="grid grid-cols-2 gap-x-4 gap-y-2 text-sm">
                              <div>
                                  <p className="text-gray-500">MSBN</p>
                                  <p className="font-medium">{patient.patientCode}</p>
                              </div>
                              <div>
                                  <p className="text-gray-500">Phòng</p>
                                  <p className="font-medium">{patient.roomNumber}</p>
                              </div>
                              <div className="col-span-2">
                                  <p className="text-gray-500">Tình trạng</p>
                                  <div className="font-medium"><StatusBadge status={patient.status} /></div>
                              </div>
                              <div className="col-span-2">
                                  <p className="text-gray-500">Chẩn đoán</p>
                                  <p className="font-medium">{patient.diagnosis}</p>
                              </div>
                          </div>
                      </div>
                      
                      {/* --- DESKTOP TABLE VIEW --- */}
                      <div className="hidden md:block font-medium text-gray-900 whitespace-nowrap">
                        {patient.name} <span className="text-gray-500">({patient.birthYear})</span>
                      </div>
                      <div className="hidden md:block">{patient.patientCode}</div>
                      <div className="hidden md:block">{patient.roomNumber}</div>
                      <div className="hidden md:block">{patient.diagnosis}</div>
                      <div className="hidden md:block"><StatusBadge status={patient.status} /></div>
                      <div className="hidden md:flex justify-end items-center space-x-2">
                        <button onClick={() => onEdit(patient)} className="font-medium text-indigo-600 hover:text-indigo-800">Sửa</button>
                        <button onClick={() => onDelete(patient)} className="font-medium text-red-600 hover:text-red-800">Xóa</button>
                      </div>
                  </div>
              ))}
          </div>
        );
      };

      const App = ({ user, auth }) => {
          const [patients, setPatients] = useState([]);
          const [isFormModalOpen, setIsFormModalOpen] = useState(false);
          const [isReportModalOpen, setIsReportModalOpen] = useState(false);
          const [isConfirmModalOpen, setIsConfirmModalOpen] = useState(false);
          const [patientToEdit, setPatientToEdit] = useState(null);
          const [patientToDeleteId, setPatientToDeleteId] = useState(null);
          const [syncStatus, setSyncStatus] = useState('idle'); // idle, loading, syncing, success, error
          const [errorMessage, setErrorMessage] = useState('');
          const [searchTerm, setSearchTerm] = useState('');
          const [sortBy, setSortBy] = useState('roomNumber');

          const handleLogout = async () => {
            try {
              await signOut(auth);
            } catch (error) {
              console.error("Lỗi khi đăng xuất:", error);
              alert("Không thể đăng xuất. Vui lòng thử lại.");
            }
          };
          
          const fetchData = async () => {
              setSyncStatus('loading');
              setErrorMessage('');
              try {
                  const patientsCollection = collection(db, 'patients');
                  const patientSnapshot = await getDocs(patientsCollection);
                  const patientsList = patientSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                  setPatients(patientsList);
                  setSyncStatus('success');
              } catch (error) {
                  console.error("Lỗi khi tải dữ liệu từ Firestore:", error);
                  setSyncStatus('error');
                  setErrorMessage(error.message || 'Không thể tải dữ liệu.');
              }
          };
          
          useEffect(() => {
              fetchData();
          }, []);
          
          useEffect(() => {
            if (syncStatus === 'success') {
              const timer = setTimeout(() => setSyncStatus('idle'), 3000);
              return () => clearTimeout(timer);
            }
          }, [syncStatus]);
          
          const { activePatients, dischargedPatients } = useMemo(() => {
            const filtered = patients
                .filter(p =>
                    (p.name || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (p.patientCode || '').toLowerCase().includes(searchTerm.toLowerCase())
                );
            
            const active = filtered
              .filter(p => p.status !== AdmissionStatus.DISCHARGED)
              .sort((a, b) => {
                    if (sortBy === 'name') {
                        return (a.name || '').localeCompare(b.name || '', 'vi');
                    }
                    return (a.roomNumber || '').localeCompare(b.roomNumber || '', undefined, { numeric: true });
                });
            
            const discharged = filtered
              .filter(p => p.status === AdmissionStatus.DISCHARGED)
              .sort((a, b) => {
                  const lastUpdateA = a.history?.[a.history.length - 1]?.date;
                  const lastUpdateB = b.history?.[b.history.length - 1]?.date;

                  if (lastUpdateA && lastUpdateB) {
                      if (lastUpdateB > lastUpdateA) return 1;
                      if (lastUpdateB < lastUpdateA) return -1;
                  }
                  if (lastUpdateB) return 1;
                  if (lastUpdateA) return -1;

                  return (a.name || '').localeCompare(b.name || '', 'vi');
              });
            
            return { activePatients: active, dischargedPatients: discharged };

          }, [patients, searchTerm, sortBy]);

          const patientToDelete = useMemo(() => 
            patientToDeleteId ? patients.find(p => p.id === patientToDeleteId) : null,
            [patientToDeleteId, patients]
          );

          const handleAddPatientClick = () => {
              setPatientToEdit(null);
              setIsFormModalOpen(true);
          };

          const handleEditPatientClick = (patient) => {
              setPatientToEdit(patient);
              setIsFormModalOpen(true);
          };

          const handleDeletePatientClick = (patient) => {
              setPatientToDeleteId(patient.id);
              setIsConfirmModalOpen(true);
          };
          
          const confirmDeletePatient = async () => {
              if (!patientToDeleteId) return;

              const originalPatients = [...patients];
              const newPatients = patients.filter(p => p.id !== patientToDeleteId);
              setPatients(newPatients);
              
              setIsConfirmModalOpen(false);
              setSyncStatus('syncing');

              try {
                  await deleteDoc(doc(db, 'patients', patientToDeleteId));
                  setSyncStatus('success');
              } catch (error) {
                  setPatients(originalPatients);
                  setSyncStatus('error');
                  setErrorMessage(`Lỗi xóa: ${error.message}`);
              } finally {
                setPatientToDeleteId(null);
              }
          };
          
           const handleSavePatient = async (patientData) => {
                const originalPatients = [...patients];
                setSyncStatus('syncing');
                setIsFormModalOpen(false);

                if (patientData.id) { // UPDATE
                    const newHistoryEntry = {
                        date: new Date().toISOString(),
                        diagnosis: patientData.diagnosis,
                        notes: patientData.newNote || '',
                    };

                    const newPatients = patients.map(p => {
                        if (p.id === patientData.id) {
                            const updatedHistory = [...(p.history || []), newHistoryEntry];
                            return { ...p, ...patientData, notes: patientData.newNote, history: updatedHistory };
                        }
                        return p;
                    });
                    
                    setPatients(newPatients);

                    try {
                        const patientDocRef = doc(db, 'patients', patientData.id);
                        const updatedPatientData = newPatients.find(p => p.id === patientData.id);
                        const { id, newNote, ...dataToSave } = updatedPatientData;
                        await updateDoc(patientDocRef, dataToSave);
                        setSyncStatus('success');
                    } catch(error) {
                        setPatients(originalPatients);
                        setSyncStatus('error');
                        setErrorMessage(`Lỗi cập nhật: ${error.message}`);
                    }
                } else { // ADD
                    const newHistoryEntry = {
                        date: new Date().toISOString(),
                        diagnosis: patientData.diagnosis,
                        notes: patientData.notes || '',
                    };
                    const tempId = crypto.randomUUID();
                    const newPatient = {
                        ...patientData,
                        id: tempId,
                        history: [newHistoryEntry],
                    };
                    
                    setPatients([newPatient, ...patients]);
                    
                    try {
                        const { id, ...dataToSave } = newPatient;
                        const docRef = await addDoc(collection(db, "patients"), dataToSave);
                        setPatients(current => current.map(p => p.id === tempId ? { ...p, id: docRef.id } : p));
                        setSyncStatus('success');
                    } catch(error) {
                        setPatients(originalPatients);
                        setSyncStatus('error');
                        setErrorMessage(`Lỗi thêm mới: ${error.message}`);
                    }
                }
            };
          
          const DesktopHeader = () => (
            <div className="hidden md:grid md:grid-cols-[50px_1fr_120px_100px_1fr_120px_120px] gap-x-6 px-6 py-3 text-xs text-gray-700 uppercase bg-gray-50 font-medium items-center">
                <span className="text-center">STT</span>
                <span>Họ Tên</span>
                <span>MSBN</span>
                <span>Phòng</span>
                <span>Chẩn Đoán</span>
                <span>Tình Trạng</span>
                <span className="text-right">Hành Động</span>
            </div>
          );

          return (
              <div className="min-h-screen bg-gray-100 text-gray-800 flex flex-col">
                  <header className="bg-white shadow-md no-print">
                      <div className="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                          <div>
                            <h1 className="text-2xl font-bold text-indigo-600">Quản lý bệnh nhân nội trú Ung bướu</h1>
                            <SyncStatusIndicator status={syncStatus} error={errorMessage} />
                          </div>
                          <div className="flex items-center space-x-2 sm:space-x-4">
                              <div className="flex items-center space-x-3">
                                  <span className="text-sm text-gray-600 hidden sm:inline" aria-label={`Logged in as ${user.email}`}>{user.email}</span>
                                  <button onClick={handleLogout} className="flex items-center space-x-2 text-sm font-medium text-gray-600 hover:bg-gray-100 hover:text-gray-900 px-3 py-2 rounded-md transition-colors" aria-label="Đăng xuất">
                                      <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor">
                                          <path fillRule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clipRule="evenodd" />
                                      </svg>
                                      <span className="hidden sm:inline">Đăng xuất</span>
                                  </button>
                              </div>
                              <div className="h-8 border-l border-gray-200"></div>
                               <button onClick={() => setIsReportModalOpen(true)} className="bg-green-500 text-white px-4 py-2 rounded-md shadow hover:bg-green-600 transition-colors flex items-center space-x-2">
                                   <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fillRule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clipRule="evenodd" /></svg>
                                  <span className="hidden sm:inline">Xem Báo Cáo</span>
                              </button>
                              <button onClick={handleAddPatientClick} className="bg-indigo-600 text-white px-4 py-2 rounded-md shadow hover:bg-indigo-700 transition-colors flex items-center space-x-2">
                                   <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd" /></svg>
                                   <span className="hidden sm:inline">Thêm Bệnh Nhân</span>
                              </button>
                          </div>
                      </div>
                  </header>

                  <main className="container mx-auto p-4 sm:p-6 lg:p-8 flex-grow no-print">
                      <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                          <div className="p-4 bg-gray-50 border-b flex flex-col sm:flex-row items-center gap-4">
                              <div className="relative w-full sm:w-2/3 md:w-1/2">
                                  <input 
                                      type="search" 
                                      placeholder="Tìm theo tên hoặc MSBN..." 
                                      value={searchTerm}
                                      onChange={(e) => setSearchTerm(e.target.value)}
                                      className="w-full pl-10 pr-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                  />
                                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                      <svg className="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fillRule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clipRule="evenodd" />
                                      </svg>
                                  </div>
                              </div>
                              <div className="flex items-center gap-2 w-full sm:w-auto">
                                  <label htmlFor="sort" className="text-sm font-medium text-gray-600">Sắp xếp (đang điều trị):</label>
                                  <select 
                                      id="sort"
                                      value={sortBy}
                                      onChange={(e) => setSortBy(e.target.value)}
                                      className="border rounded-lg py-2 px-3 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                  >
                                      <option value="roomNumber">Số Phòng</option>
                                      <option value="name">Họ Tên</option>
                                  </select>
                              </div>
                          </div>

                          <div className="overflow-x-auto">
                              <div className="px-6 pt-6 pb-2">
                                  <h2 className="text-xl font-semibold text-gray-800">Bệnh nhân đang điều trị ({activePatients.length})</h2>
                              </div>
                              <DesktopHeader />
                              <PatientTable patients={activePatients} onEdit={handleEditPatientClick} onDelete={handleDeletePatientClick} />
                              {syncStatus !== 'loading' && activePatients.length === 0 && (
                                <div className="text-center py-10 text-gray-500">
                                  <p>{searchTerm ? `Không có bệnh nhân đang điều trị khớp với "${searchTerm}".` : 'Không có bệnh nhân nào đang điều trị.'}</p>
                                </div>
                              )}
                          </div>

                          <div className="mt-6 border-t overflow-x-auto">
                              <div className="px-6 pt-6 pb-2">
                                  <h2 className="text-xl font-semibold text-gray-800">Bệnh nhân đã ra viện ({dischargedPatients.length})</h2>
                              </div>
                              <DesktopHeader />
                              <PatientTable patients={dischargedPatients} onEdit={handleEditPatientClick} onDelete={handleDeletePatientClick} />
                               {syncStatus !== 'loading' && dischargedPatients.length === 0 && (
                                <div className="text-center py-10 text-gray-500">
                                  <p>{searchTerm ? `Không có bệnh nhân đã ra viện khớp với "${searchTerm}".` : 'Chưa có bệnh nhân nào ra viện.'}</p>
                                </div>
                              )}
                          </div>

                          {patients.length === 0 && searchTerm === '' && syncStatus !== 'loading' && (
                              <div className="text-center py-16 text-gray-500">
                                  <p>Chưa có bệnh nhân nào trong hệ thống.</p>
                                  <p>Nhấn "Thêm Bệnh Nhân" để bắt đầu.</p>
                              </div>
                          )}
                      </div>
                  </main>

                  <footer className="text-center py-4 text-xs text-gray-500 no-print">
                      bshieuubdl@gmail.com
                  </footer>

                  <Modal isOpen={isFormModalOpen} onClose={() => setIsFormModalOpen(false)} title={patientToEdit ? 'Cập Nhật Diễn Biến Bệnh Nhân' : 'Thêm Bệnh Nhân Mới'}>
                      <PatientForm onSave={handleSavePatient} onClose={() => setIsFormModalOpen(false)} patientToEdit={patientToEdit} />
                  </Modal>

                  <Modal isOpen={isReportModalOpen} onClose={() => setIsReportModalOpen(false)} title="Báo Cáo Hàng Ngày">
                      <ReportView patients={patients} onClose={() => setIsReportModalOpen(false)} />
                  </Modal>

                  <ConfirmModal 
                      isOpen={isConfirmModalOpen} 
                      onClose={() => {
                        setIsConfirmModalOpen(false);
                        setPatientToDeleteId(null);
                      }} 
                      onConfirm={confirmDeletePatient}
                      title="Xác nhận Xóa Bệnh Nhân"
                  >
                      <p>Bạn có chắc chắn muốn xóa bệnh nhân <strong>{patientToDelete?.name}</strong>? Hành động này không thể được hoàn tác.</p>
                  </ConfirmModal>
              </div>
          );
      };

      const LoginPage = ({ auth }) => {
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [error, setError] = useState('');
        const [isLoading, setIsLoading] = useState(false);

        const handleLogin = async (e) => {
          e.preventDefault();
          if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("PASTE_YOUR")) {
            setError('Ứng dụng chưa được cấu hình. Vui lòng làm theo hướng dẫn trong code.');
            return;
          }
          setIsLoading(true);
          setError('');
          try {
            await signInWithEmailAndPassword(auth, email, password);
          } catch (err) {
            setError('Đăng nhập thất bại. Vui lòng kiểm tra lại email và mật khẩu.');
            console.error(err);
          } finally {
            setIsLoading(false);
          }
        };

        return (
            <div className="min-h-screen bg-gray-50 flex flex-col justify-center items-center p-4">
              <div className="w-full max-w-sm bg-white rounded-xl shadow-lg p-8">
                  <h2 className="text-2xl font-bold text-center text-gray-800 mb-2">Hệ Thống Quản Lý Bệnh Nhân</h2>
                  <p className="text-center text-gray-500 mb-8">Vui lòng đăng nhập để tiếp tục</p>
                  <form onSubmit={handleLogin} className="space-y-6">
                      <div>
                          <label htmlFor="email" className="block text-sm font-medium text-gray-700">Email</label>
                          <input
                              id="email"
                              name="email"
                              type="email"
                              autoComplete="email"
                              required
                              value={email}
                              onChange={(e) => setEmail(e.target.value)}
                              className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500"
                          />
                      </div>
                      <div>
                          <label htmlFor="password"className="block text-sm font-medium text-gray-700">Mật khẩu</label>
                          <input
                              id="password"
                              name="password"
                              type="password"
                              autoComplete="current-password"
                              required
                              value={password}
                              onChange={(e) => setPassword(e.target.value)}
                              className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-3 focus:ring-indigo-500 focus:border-indigo-500"
                          />
                      </div>
                      {error && <p className="text-red-500 text-sm text-center">{error}</p>}
                      <div>
                          <button
                              type="submit"
                              disabled={isLoading}
                              className="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-indigo-400"
                          >
                              {isLoading ? 'Đang đăng nhập...' : 'Đăng Nhập'}
                          </button>
                      </div>
                  </form>
              </div>
            </div>
        );
      };

      const AuthGate = ({ auth }) => {
        const [user, setUser] = useState(null);
        const [isLoading, setIsLoading] = useState(true);

        useEffect(() => {
          const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
            setUser(currentUser);
            setIsLoading(false);
          });
          return () => unsubscribe();
        }, [auth]);

        if (isLoading) {
          return (
            <div className="flex justify-center items-center h-screen bg-gray-100">
              <p className="text-lg text-gray-600">Đang kiểm tra xác thực...</p>
            </div>
          );
        }

        if (user) {
          return <App user={user} auth={auth} />;
        }

        return <LoginPage auth={auth} />;
      };
      
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <AuthGate auth={firebaseAuth} />
        </React.StrictMode>
      );
    </script>
  </body>
</html>