<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Quản lý bệnh nhân nội trú Ung bướu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://rsms.me/inter/inter.css">
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
      @media print {
        .no-print {
            display: none !important;
        }
        body * {
          visibility: hidden;
        }
        #print-area, #print-area * {
          visibility: visible;
        }
        #print-area {
          position: absolute;
          left: 0;
          top: 0;
          width: 100%;
          padding: 1rem;
          margin: 0;
        }
        /* Cho phép nội dung báo cáo mở rộng để vừa với bản in */
        .modal-content-area {
            overflow-y: visible !important;
            height: auto !important;
            max-height: none !important;
        }
      }
    </style>
  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client"
  }
}
</script>
<!-- Load Babel -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
  <body class="bg-gray-100">
    <div id="root"></div>
    <!-- Babel transforms JSX and handles ES modules -->
    <script type="text/babel" data-type="module">
      import React, { useState, useMemo, useEffect } from 'react';
      import ReactDOM from 'react-dom/client';

      // --- Start of inlined code from types.js ---
      const AdmissionStatus = {
        INPATIENT: 'Nội trú',
        DISCHARGED: 'Ra viện',
        DISCHARGE_TODAY: 'Dự kiến ra viện hôm nay',
      };
      
      // --- Start of inlined code from components/Modal.js ---
      const Modal = ({ isOpen, onClose, title, children }) => {
        if (!isOpen) return null;

        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4 no-print">
            <div className="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
              <div className="flex justify-between items-center p-4 border-b">
                <h2 className="text-xl font-bold text-gray-800">{title}</h2>
                <button
                  onClick={onClose}
                  className="text-gray-500 hover:text-gray-800 transition-colors"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
              <div className="p-6 overflow-y-auto modal-content-area">
                {children}
              </div>
            </div>
          </div>
        );
      };

      // --- Start of inlined code from components/PatientForm.js ---
      const PatientForm = ({ onSave, onClose, patientToEdit }) => {
        const [formData, setFormData] = useState({
          name: '',
          birthYear: '',
          patientCode: '',
          roomNumber: '',
          reason: '',
          diagnosis: '',
          status: AdmissionStatus.INPATIENT,
          notes: '',
        });

        useEffect(() => {
          if (patientToEdit) {
            setFormData({
              name: patientToEdit.name,
              birthYear: patientToEdit.birthYear.toString(),
              patientCode: patientToEdit.patientCode,
              roomNumber: patientToEdit.roomNumber,
              reason: patientToEdit.reason,
              // Lấy chẩn đoán và ghi chú mới nhất từ lịch sử
              diagnosis: patientToEdit.diagnosis,
              status: patientToEdit.status,
              notes: patientToEdit.notes,
            });
          } else {
             // Reset form cho bệnh nhân mới
            setFormData({
              name: '',
              birthYear: '',
              patientCode: '',
              roomNumber: '',
              reason: '',
              diagnosis: '',
              status: AdmissionStatus.INPATIENT,
              notes: '',
            });
          }
        }, [patientToEdit]);

        const handleChange = (e) => {
          const { name, value } = e.target;
          setFormData(prev => ({ ...prev, [name]: value }));
        };

        const handleSubmit = (e) => {
          e.preventDefault();
          const patientData = {
            ...formData,
            birthYear: parseInt(formData.birthYear, 10),
          };
          if (patientToEdit) {
            onSave({ ...patientData, id: patientToEdit.id });
          } else {
            onSave(patientData);
          }
        };
        
        const sortedHistory = patientToEdit?.history?.slice().reverse() ?? [];

        return (
          <form onSubmit={handleSubmit} className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700">Họ tên bệnh nhân</label>
                <input type="text" name="name" value={formData.name} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" required />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">Năm sinh</label>
                <input type="number" name="birthYear" value={formData.birthYear} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" required />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700">Mã số bệnh nhân</label>
                <input type="text" name="patientCode" value={formData.patientCode} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" required />
              </div>
               <div>
                <label className="block text-sm font-medium text-gray-700">Số phòng</label>
                <input type="text" name="roomNumber" value={formData.roomNumber} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500" required />
              </div>
               <div>
                <label className="block text-sm font-medium text-gray-700">Tình trạng nhập viện</label>
                <select name="status" value={formData.status} onChange={handleChange} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500">
                  {Object.values(AdmissionStatus).map(status => (
                    <option key={status} value={status}>{status}</option>
                  ))}
                </select>
              </div>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">Lý do vào viện</label>
              <textarea name="reason" value={formData.reason} onChange={handleChange} rows={3} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700">Chẩn đoán hiện tại</label>
              <textarea name="diagnosis" value={formData.diagnosis} onChange={handleChange} rows={3} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>
             <div>
              <label className="block text-sm font-medium text-gray-700">Ghi chú / Bàn giao (Mới)</label>
              <textarea name="notes" value={formData.notes} onChange={handleChange} rows={3} className="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2 focus:ring-indigo-500 focus:border-indigo-500"></textarea>
            </div>

            {patientToEdit && sortedHistory.length > 0 && (
                <div className="pt-4 mt-4 border-t">
                    <h3 className="text-lg font-medium text-gray-800 mb-2">Lịch sử điều trị & Ghi chú</h3>
                    <div className="space-y-3 max-h-60 overflow-y-auto pr-2">
                        {sortedHistory.map((entry, index) => (
                            <div key={index} className="bg-gray-50 p-3 rounded-md border border-gray-200">
                                <p className="text-xs font-semibold text-gray-500 mb-1">
                                    {new Date(entry.date).toLocaleString('vi-VN')}
                                </p>
                                <p className="text-sm"><span className="font-semibold">Chẩn đoán:</span> {entry.diagnosis}</p>
                                <p className="text-sm"><span className="font-semibold">Ghi chú:</span> {entry.notes}</p>
                            </div>
                        ))}
                    </div>
                </div>
            )}

            <div className="flex justify-end space-x-3 pt-4">
              <button type="button" onClick={onClose} className="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors">Hủy</button>
              <button type="submit" className="bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors">{patientToEdit ? 'Cập nhật' : 'Lưu'}</button>
            </div>
          </form>
        );
      };

      // --- Start of inlined code from components/ReportView.js ---
      const ReportView = ({ patients, onClose }) => {
        const patientsToReport = patients.filter(
          p => p.status === AdmissionStatus.INPATIENT || p.status === AdmissionStatus.DISCHARGE_TODAY
        );

        const handlePrint = () => {
          window.print();
        };
        
        const today = new Date().toLocaleDateString('vi-VN');

        return (
          <div className="space-y-6">
            <div id="print-area">
              <h3 className="text-2xl font-bold text-center text-gray-800 mb-2">Báo cáo bệnh nhân nội trú Ung bướu</h3>
              <p className="text-center text-gray-600 mb-6">Ngày: {today}</p>
              
              <div className="space-y-4">
                  {patientsToReport.length > 0 ? (
                      patientsToReport.map((patient) => (
                          <div key={patient.id} className="p-4 border border-gray-200 rounded-lg bg-gray-50 break-inside-avoid">
                              <div className="flex justify-between items-start">
                                 <h4 className="text-lg font-semibold text-indigo-700">{patient.name} - {patient.birthYear}</h4>
                                 <span className={`text-sm font-medium px-2 py-1 rounded-full ${
                                  patient.status === AdmissionStatus.INPATIENT ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'
                                 }`}>
                                   {patient.status}
                                 </span>
                              </div>
                              <p className="text-sm text-gray-500 mb-2">MSBN: {patient.patientCode} | Phòng: {patient.roomNumber}</p>
                              <div className="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                  <p><span className="font-semibold text-gray-600">Lý do vào viện:</span> {patient.reason}</p>
                                  <p><span className="font-semibold text-gray-600">Chẩn đoán:</span> {patient.diagnosis}</p>
                                  <p className="col-span-2"><span className="font-semibold text-gray-600">Ghi chú:</span> {patient.notes}</p>
                              </div>
                          </div>
                      ))
                  ) : (
                      <p className="text-center text-gray-500 py-8">Không có bệnh nhân nào cần báo cáo.</p>
                  )}
              </div>
              <div className="mt-8 text-right text-sm text-gray-600">
                  <p>copyright bshieuubdl@gmail.com</p>
              </div>
            </div>
            <div className="flex justify-end space-x-3 pt-4 no-print">
              <button type="button" onClick={onClose} className="bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300 transition-colors">Đóng</button>
              <button type="button" onClick={handlePrint} className="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 transition-colors flex items-center space-x-2">
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fillRule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm8 0H7v3h6V4zm0 8H7V9h6v3z" clipRule="evenodd" />
                  </svg>
                  <span>In Báo Cáo</span>
              </button>
            </div>
          </div>
        );
      };

      // --- Start of inlined code from App.js ---
      const initialPatients = [
          { 
            id: '1', name: 'Nguyễn Văn An', birthYear: 1985, patientCode: 'BN001', roomNumber: 'P101', 
            reason: 'Đau bụng cấp', diagnosis: 'Viêm ruột thừa', status: AdmissionStatus.INPATIENT, 
            notes: 'Theo dõi sát', 
            history: [{ date: '2023-10-26T10:00:00Z', diagnosis: 'Viêm ruột thừa', notes: 'Theo dõi sát' }]
          },
          { 
            id: '2', name: 'Trần Thị Bình', birthYear: 1992, patientCode: 'BN002', roomNumber: 'P102', 
            reason: 'Ho kéo dài', diagnosis: 'Viêm phế quản', status: AdmissionStatus.DISCHARGE_TODAY, 
            notes: 'Kê đơn thuốc 7 ngày',
            history: [{ date: '2023-10-26T11:30:00Z', diagnosis: 'Viêm phế quản', notes: 'Kê đơn thuốc 7 ngày' }]
          },
          { 
            id: '3', name: 'Lê Hoàng Cường', birthYear: 1970, patientCode: 'BN003', roomNumber: 'P205', 
            reason: 'Khó thở', diagnosis: 'Hen suyễn', status: AdmissionStatus.INPATIENT, 
            notes: 'Cần thở oxy',
            history: [{ date: '2023-10-25T15:00:00Z', diagnosis: 'Hen suyễn', notes: 'Cần thở oxy' }]
          },
          { 
            id: '4', name: 'Phạm Thị Dung', birthYear: 2001, patientCode: 'BN004', roomNumber: 'P310', 
            reason: 'Gãy tay', diagnosis: 'Gãy xương cẳng tay', status: AdmissionStatus.DISCHARGED, 
            notes: 'Đã bó bột, tái khám sau 2 tuần',
            history: [{ date: '2023-10-24T09:00:00Z', diagnosis: 'Gãy xương cẳng tay', notes: 'Đã bó bột, tái khám sau 2 tuần' }]
          },
      ];

      const StatusBadge = ({ status }) => {
          const statusClasses = useMemo(() => {
              switch (status) {
                  case AdmissionStatus.INPATIENT:
                      return 'bg-blue-100 text-blue-800';
                  case AdmissionStatus.DISCHARGE_TODAY:
                      return 'bg-yellow-100 text-yellow-800';
                  case AdmissionStatus.DISCHARGED:
                      return 'bg-green-100 text-green-800';
                  default:
                      return 'bg-gray-100 text-gray-800';
              }
          }, [status]);

          return (
              <span className={`px-3 py-1 text-xs font-medium rounded-full ${statusClasses}`}>
                  {status}
              </span>
          );
      };

      const App = () => {
          const [patients, setPatients] = useState(() => {
            try {
              const savedPatients = localStorage.getItem('patientsData');
              return savedPatients ? JSON.parse(savedPatients) : initialPatients;
            } catch (error) {
              console.error("Lỗi khi đọc dữ liệu từ localStorage:", error);
              return initialPatients;
            }
          });

          const [isFormModalOpen, setIsFormModalOpen] = useState(false);
          const [isReportModalOpen, setIsReportModalOpen] = useState(false);
          const [patientToEdit, setPatientToEdit] = useState(null);
          
          useEffect(() => {
            try {
              localStorage.setItem('patientsData', JSON.stringify(patients));
            } catch (error) {
              console.error("Lỗi khi lưu dữ liệu vào localStorage:", error);
            }
          }, [patients]);

          const handleAddPatientClick = () => {
              setPatientToEdit(null);
              setIsFormModalOpen(true);
          };

          const handleEditPatientClick = (patient) => {
              setPatientToEdit(patient);
              setIsFormModalOpen(true);
          };

          const handleDeletePatient = (patientId) => {
              if (window.confirm('Bạn có chắc chắn muốn xóa bệnh nhân này?')) {
                  setPatients(patients.filter(p => p.id !== patientId));
              }
          };
          
          const handleSavePatient = (patientData) => {
              if (patientData.id) {
                  // Chỉnh sửa bệnh nhân
                  setPatients(patients.map(p => {
                      if (p.id === patientData.id) {
                          const newHistoryEntry = {
                              date: new Date().toISOString(),
                              diagnosis: patientData.diagnosis,
                              notes: patientData.notes,
                          };

                          // Chỉ thêm vào lịch sử nếu có thay đổi
                          const latestHistory = p.history[p.history.length - 1] || {};
                          const hasChanged = latestHistory.diagnosis !== newHistoryEntry.diagnosis || latestHistory.notes !== newHistoryEntry.notes;
                          
                          const updatedHistory = hasChanged ? [...p.history, newHistoryEntry] : p.history;

                          return { ...p, ...patientData, history: updatedHistory };
                      }
                      return p;
                  }));
              } else {
                  // Thêm bệnh nhân mới
                  const newHistoryEntry = {
                      date: new Date().toISOString(),
                      diagnosis: patientData.diagnosis,
                      notes: patientData.notes,
                  };
                  const newPatient = {
                      ...patientData,
                      id: crypto.randomUUID(),
                      history: [newHistoryEntry],
                  };
                  setPatients([newPatient, ...patients]);
              }
              setIsFormModalOpen(false);
          };

          return (
              <div className="min-h-screen bg-gray-100 text-gray-800 flex flex-col">
                  <header className="bg-white shadow-md no-print">
                      <div className="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
                          <h1 className="text-2xl font-bold text-indigo-600">Quản lý bệnh nhân nội trú Ung bướu</h1>
                          <div className="space-x-3">
                               <button onClick={() => setIsReportModalOpen(true)} className="bg-green-500 text-white px-4 py-2 rounded-md shadow hover:bg-green-600 transition-colors flex items-center space-x-2">
                                   <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fillRule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clipRule="evenodd" /></svg>
                                  <span>Xem Báo Cáo</span>
                              </button>
                              <button onClick={handleAddPatientClick} className="bg-indigo-600 text-white px-4 py-2 rounded-md shadow hover:bg-indigo-700 transition-colors flex items-center space-x-2">
                                   <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clipRule="evenodd" /></svg>
                                   <span>Thêm Bệnh Nhân</span>
                              </button>
                          </div>
                      </div>
                  </header>

                  <main className="container mx-auto p-4 sm:p-6 lg:p-8 flex-grow no-print">
                      <div className="bg-white rounded-lg shadow-lg overflow-hidden">
                          <div className="overflow-x-auto">
                              <table className="w-full text-sm text-left text-gray-500">
                                  <thead className="text-xs text-gray-700 uppercase bg-gray-50">
                                      <tr>
                                          <th scope="col" className="px-6 py-3">Họ Tên</th>
                                          <th scope="col" className="px-6 py-3">MSBN</th>
                                          <th scope="col" className="px-6 py-3">Phòng</th>
                                          <th scope="col" className="px-6 py-3">Chẩn Đoán</th>
                                          <th scope="col" className="px-6 py-3">Tình Trạng</th>
                                          <th scope="col" className="px-6 py-3 text-right">Hành Động</th>
                                      </tr>
                                  </thead>
                                  <tbody>
                                      {patients.map(patient => (
                                          <tr key={patient.id} className="bg-white border-b hover:bg-gray-50">
                                              <td className="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">
                                                  {patient.name} <span className="text-gray-500">({patient.birthYear})</span>
                                              </td>
                                              <td className="px-6 py-4">{patient.patientCode}</td>
                                              <td className="px-6 py-4">{patient.roomNumber}</td>
                                              <td className="px-6 py-4">{patient.diagnosis}</td>
                                              <td className="px-6 py-4">
                                                  <StatusBadge status={patient.status} />
                                              </td>
                                              <td className="px-6 py-4 text-right space-x-2">
                                                  <button onClick={() => handleEditPatientClick(patient)} className="font-medium text-indigo-600 hover:text-indigo-800">Sửa</button>
                                                  <button onClick={() => handleDeletePatient(patient.id)} className="font-medium text-red-600 hover:text-red-800">Xóa</button>
                                              </td>
                                          </tr>
                                      ))}
                                  </tbody>
                              </table>
                          </div>
                      </div>
                      {patients.length === 0 && (
                          <div className="text-center py-16 text-gray-500">
                              <p>Chưa có thông tin bệnh nhân nào.</p>
                              <p>Nhấn "Thêm Bệnh Nhân" để bắt đầu.</p>
                          </div>
                      )}
                  </main>

                  <footer className="text-center py-4 text-sm text-gray-500 no-print">
                      copyright bshieuubdl@gmail.com
                  </footer>

                  <Modal isOpen={isFormModalOpen} onClose={() => setIsFormModalOpen(false)} title={patientToEdit ? 'Chỉnh Sửa Thông Tin Bệnh Nhân' : 'Thêm Bệnh Nhân Mới'}>
                      <PatientForm onSave={handleSavePatient} onClose={() => setIsFormModalOpen(false)} patientToEdit={patientToEdit} />
                  </Modal>

                  <Modal isOpen={isReportModalOpen} onClose={() => setIsReportModalOpen(false)} title="Báo Cáo Hàng Ngày">
                      <ReportView patients={patients} onClose={() => setIsReportModalOpen(false)} />
                  </Modal>
              </div>
          );
      };
      
      // --- Start of inlined code from index.js ---
      const rootElement = document.getElementById('root');
      if (!rootElement) {
        throw new Error("Could not find root element to mount to");
      }

      const root = ReactDOM.createRoot(rootElement);
      root.render(
        <React.StrictMode>
          <App />
        </React.StrictMode>
      );
    </script>
  </body>
</html>